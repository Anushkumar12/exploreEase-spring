<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My Bookings | ExploreEase</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <style>
    body { background-color: #f8f9fa; }
    .booking-card {
      background-color: #fff;
      border-left: 5px solid #0d6efd;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      transition: all 0.3s ease;
    }
    .booking-card:hover { transform: translateY(-3px); box-shadow: 0 6px 15px rgba(0,0,0,0.1); }
    .booking-image-container { height: 200px; overflow: hidden; border-bottom: 1px solid #f0f0f0; }
    .booking-image { width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s ease; }
    .booking-card:hover .booking-image { transform: scale(1.05); }
    .card-body-content { padding: 15px; }
    .badge { font-size: 0.85em; padding: 0.5em 0.8em; }
  </style>
</head>
<body>
  <div class="container my-5">
    <h1 class="text-center mb-5 text-primary">‚úàÔ∏è Your Booked Tours</h1>

    <div id="not-logged-in" style="display:none;" class="text-center py-5">
      <div class="alert alert-warning shadow-sm mx-auto" style="max-width: 500px;" role="alert">
        <h4 class="alert-heading">üîê Login Required</h4>
        <p class="mb-3">Please log in to view and manage your booked tours.</p>
        <a href="/login" class="btn btn-primary btn-lg mt-2">Go to Login</a>
      </div>
    </div>

    <div id="bookingsContainer" class="row g-4">
      <div class="col-12 text-center text-muted">Loading your bookings...</div>
    </div>
  </div>

  <script>
    function formatDate(isoString) {
      if (!isoString) return 'N/A';
      const date = new Date(isoString);
      const options = { year:'numeric', month:'short', day:'numeric', hour:'2-digit', minute:'2-digit' };
      return date.toLocaleDateString('en-US', options);
    }

    function renderBookings(bookings) {
      const container = document.getElementById("bookingsContainer");
      container.innerHTML = "";

      if (!bookings || bookings.length === 0) {
        container.innerHTML = `
          <div class="col-12 text-center py-5">
            <div class="alert alert-info shadow">
              <h4 class="alert-heading">No Bookings Found!</h4>
              <p>You haven't booked any tours yet.</p>
              <a href="/tours" class="btn btn-primary mt-2">Browse Tours</a>
            </div>
          </div>`;
        return;
      }

      bookings.forEach(b => {
        const isConfirmed = b.status === 'CONFIRMED';
        const statusBadgeClass = isConfirmed ? 'bg-success' : 'bg-danger';
        const statusText = isConfirmed ? 'Confirmed' : (b.status === 'CANCELLED' ? 'Cancelled' : b.status);

        const card = document.createElement("div");
        card.classList.add("col-md-6","col-lg-4");
        card.innerHTML = `
          <div class="booking-card h-100 d-flex flex-column">
            <div class="booking-image-container">
              <img src="${b.tour.imageUrl || '/images/default.png'}" alt="${b.tour.title}" class="booking-image" />
            </div>
            <div class="card-body-content flex-grow-1">
              <h5 class="card-title text-primary">${b.tour.title}</h5>
              <ul class="list-unstyled mt-3 mb-3 small">
                <li><strong><i class="bi bi-geo-alt-fill"></i> Location:</strong> ${b.tour.location}</li>
                <li><strong><i class="bi bi-person-fill"></i> Seats:</strong> ${b.seatsBooked}</li>
                <li><strong><i class="bi bi-calendar-check-fill"></i> Booked On:</strong> ${formatDate(b.createdAt)}</li>
                <li><strong><i class="bi bi-clock-fill"></i> Duration:</strong> ${b.tour.durationDays} days</li>
              </ul>
              <p class="mb-3"><strong>Status:</strong> <span class="badge ${statusBadgeClass}">${statusText}</span></p>
              ${isConfirmed 
                ? `<button onclick="cancelBooking(${b.id})" class="btn btn-danger btn-sm w-100">Cancel Booking</button>`
                : `<button class="btn btn-secondary btn-sm w-100" disabled>Cannot Cancel (${statusText})</button>`
              }
            </div>
          </div>`;
        container.appendChild(card);
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      const container = document.getElementById("bookingsContainer");
      const loginPrompt = document.getElementById("not-logged-in");
      const token = localStorage.getItem('ee_token');

      if (!token) {
        container.innerHTML = ""; 
        loginPrompt.style.display = "block";
        return;
      }

      fetch('/api/bookings/my', {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token
        }
      })
      .then(res => {
        if (res.status === 401 || res.status === 403) {
          container.innerHTML = "";
          loginPrompt.style.display = "block";
          localStorage.removeItem('ee_token');
          return [];
        }
        if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
        return res.json();
      })
      .then(renderBookings)
      .catch(error => {
        console.error("Error fetching bookings:", error);
        container.innerHTML = `
          <div class="col-12 text-center py-5">
            <div class="alert alert-warning">
              <h4 class="alert-heading">Data Error!</h4>
              <p>Could not load bookings. Try again later.</p>
            </div>
          </div>`;
      });
    });

    function cancelBooking(bookingId) {
      if (!confirm("Are you sure you want to cancel this booking?")) return;
      const token = localStorage.getItem('ee_token');
      fetch(`/api/bookings/cancel/${bookingId}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token
        }
      })
      .then(res => {
        if (res.ok) {
          alert("Booking cancelled successfully!");
          location.reload();
        } else {
          return res.text().then(text => { throw new Error(text || "Failed to cancel booking."); });
        }
      })
      .catch(err => alert(`Failed to cancel booking: ${err.message}`));
    }
  </script>
</body>
</html>
